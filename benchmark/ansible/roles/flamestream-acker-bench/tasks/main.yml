---
- name: Copy the deployer file
  template:
    src: deployer.conf.j2
    dest: "{{ flamestream_dir }}/deployer.conf"

- name: Copy the bench configuration file
  template:
    src: bench.conf.j2
    dest: "{{ flamestream_dir }}/bench.conf"

- name: Start the flamestream bench
  shell: >
    java
    -Daeron.term.buffer.length=4194304 -Daeron.mtu.length=16384 -Xms1500m -Xmx1500m -XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError
    -cp '{{ flamestream_dir }}/lib/*'
    {{ bench_class }}
    {{ flamestream_dir }}/bench.conf {{ flamestream_dir }}/deployer.conf > {{ flamestream_dir }}/bench.log 2>&1
  environment: "{{ worker_environment | default({}) }}"

- name: Fetch bench logs
  fetch:
    src: "{{ flamestream_dir }}/bench.log"
    dest: "{{ results_dir }}/flamestream/bench.log"
    flat: true

- name: Fetch latencies
  fetch:
    src: /tmp/lat.data
    dest: "{{ results_dir }}/flamestream/latency/lat.data"
    flat: true

- fetch:
    src: /tmp/duration
    dest: "{{ results_dir }}/flamestream/duration.txt"
    flat: true

- fetch:
    src: /tmp/durations
    dest: "{{ results_dir }}/flamestream/durations.txt"
    flat: true

- fetch:
    src: /tmp/notification_await_times.csv
    dest: "{{ results_dir }}/flamestream/notification_await_times.csv"
    flat: true
